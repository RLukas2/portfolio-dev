name: Lighthouse CI

on:
  pull_request:
    branches: [main]
  # Optional: Run on main branch pushes too
  # push:
  #   branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: ðŸ”¦ Lighthouse Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Use mock/minimal env for build (no real DB needed for static analysis)
      - name: Create minimal env
        run: |
          echo "NEXT_PUBLIC_APP_URL=http://localhost:3000" >> .env
          echo "NEXT_PUBLIC_AVAILABLE_FOR_HIRE=true" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          echo "NEXTAUTH_SECRET=test-secret-for-ci-build-only" >> .env
          echo "SKIP_ENV_VALIDATION=1" >> .env

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Build Next.js
        run: pnpm build
        env:
          SKIP_ENV_VALIDATION: '1'
        continue-on-error: true

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          # Run against the built static files or a live URL
          urls: |
            http://localhost:3000/
          uploadArtifacts: true
          temporaryPublicStorage: true
          # Optional: Use a config file for thresholds
          # configPath: ./lighthouserc.json

      - name: Format Lighthouse Score
        id: format_lighthouse_score
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('.lighthouseci/manifest.json'));

            let comment = '## âš¡ Lighthouse Report\n\n';

            for (const result of results) {
              const summary = JSON.parse(fs.readFileSync(result.jsonPath));
              const { categories } = summary;
              
              const formatScore = (score) => {
                const pct = Math.round(score * 100);
                if (pct >= 90) return `ðŸŸ¢ ${pct}`;
                if (pct >= 50) return `ðŸŸ  ${pct}`;
                return `ðŸ”´ ${pct}`;
              };
              
              comment += `| Category | Score |\n`;
              comment += `|----------|-------|\n`;
              comment += `| Performance | ${formatScore(categories.performance.score)} |\n`;
              comment += `| Accessibility | ${formatScore(categories.accessibility.score)} |\n`;
              comment += `| Best Practices | ${formatScore(categories['best-practices'].score)} |\n`;
              comment += `| SEO | ${formatScore(categories.seo.score)} |\n`;
            }

            return comment;
        continue-on-error: true
